<head>
	<link rel="stylesheet" href="leaflet.css" /> 
	<style>
		html, body, #map { width:100%; height:100%; margin:0; padding:0; }
	</style>
</head>
<body>
	<div id="map"></div>
	<script src="leaflet.js"></script>
 	<script src="tabletop.js"></script>
 	<script src="Leaflet.LocationShare.js"></script>

	<script>
		var mapMinZoom = 0;
		var mapMaxZoom = 6;
 
		var map = L.map('map').setView([0, 0], 0);
		var code = "1VtxMqver7ocbImx9IdTsTX0KdfAgbRCJcRK-J2w5yv8"
 
		var mapBounds = new L.LatLngBounds(
			map.unproject([0, 16384],mapMaxZoom),
			map.unproject([16384, 8602],mapMaxZoom));
 
		map.fitBounds(mapBounds);
 
		L.tileLayer('http://aequitas.lostportals.com/map/{z}/{x}/{y}.png', {
			minZoom: 2,
			maxZoom: 6,
			attribution: 'Aequitas Black Desert Map',
			tms: true,
			continuousWorld: true,
			noWarp: true  
		}).addTo(map);

		var popup = L.popup();

		function onMapClick(e) {
    	popup
        	.setLatLng(e.latlng)
        	.setContent("The coordinates for this location are: " + e.latlng.toString())
        	.openOn(map);
		};

		map.on('click', onMapClick);

		var LeafIcon = L.Icon.extend({
    		options: {
        	iconSize:     [47, 37],
        	iconAnchor:   [25, 45],
        	popupAnchor:  [0, -47]
    		}
		});

		var   	fish = new LeafIcon({iconUrl: './img/fish.png'});
		var		town = new LeafIcon({iconUrl: './img/town.png'});
		var		treasure = new LeafIcon({iconUrl: './img/treasure.png'});
		var		horse = new LeafIcon({iconUrl: './img/horse.png'});
		var		boss = new LeafIcon({iconUrl: './img/boss.png'});
		var		misc = new LeafIcon({iconUrl: './img/misc.png'});

		tabletop1 = Tabletop.init({ 
		         key: code, 
		         callback: function(data, tabletop) {
		            var sheets = tabletop.sheets();
		              for (var sheetName in sheets) {
		              	if (sheetName == "TreeGatherMap") continue;
		                iconToUse = (sheetName == "Fishing") ? fish : (sheetName == "TreasureChests") ? treasure : (sheetName == "Towns") ? town : (sheetName == "HorseSpawns") ? horse : (sheetName == "BossSpawns") ? boss :  misc;
		                tabletop.sheets(sheetName).all().forEach(function(row) {
		              var screenshot = (!row.screenshot || row.screenshot == "") ? "" : screenshot = '<br /><a href="' + row.screenshot + '"><img src="' + row.screenshot + '" width="300px"></img></a>';
		              var notes = (!row.notes || row.notes == "") ? "" : "<br />" + row.notes;
		                        var popupData = row.name + notes + screenshot;
		                        L.marker([row.lat, row.lon], {icon: iconToUse}).addTo(map).bindPopup(popupData);
		              });
		            }
		         }
		    });
	    tabletop2 = Tabletop.init({ 
	         key: code, 
	         callback: function(data, tabletop) {
	            tabletop.sheets("BossSpawns").all().forEach(function(row) {
	                  L.circle([row.lat, row.lon], 11000, {color: 'red', fillColor: '#f03', fillOpacity: 0.5}).addTo(map);
	            });
	         }
	    }); 
	</script>
</body>
</html>
